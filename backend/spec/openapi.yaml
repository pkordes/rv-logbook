openapi: "3.0.0"
info:
  title: RV Logbook API
  version: "0.1.0"
  description: API for tracking RV trips, stops, and tags.

paths:
  /healthz:
    get:
      operationId: GetHealth
      summary: Health check
      description: Returns 200 when the server is ready to accept traffic.
      tags:
        - health
      responses:
        "200":
          description: Server is healthy.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /export:
    get:
      operationId: GetExport
      summary: Export all trips, stops, and tags as a flat table
      description: |
        Returns one row per stop across all trips, with trip fields repeated per stop.
        Trips with no stops yield one row with empty stop fields.
        Responds with JSON (default) or CSV depending on the Accept header or ?format param.
      tags:
        - export
      parameters:
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [json, csv]
          description: Response format. Overrides the Accept header when provided.
      responses:
        "200":
          description: Export data — one row per stop.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ExportRow"
            text/csv:
              schema:
                type: string

  /tags:
    get:
      operationId: ListTags
      summary: List tags, optionally filtered by name prefix
      description: Returns tags whose slug starts with the normalized q parameter. Pass no q to return all tags. Useful for autocomplete.
      tags:
        - tags
      parameters:
        - name: q
          in: query
          required: false
          schema:
            type: string
          description: Filter by slug prefix (case-insensitive).
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed).
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page (max 100).
      responses:
        "200":
          description: A paginated list of matching tags ordered by slug.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TagList"

  /trips:
    post:
      operationId: CreateTrip
      summary: Create a trip
      tags:
        - trips
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTripRequest"
      responses:
        "201":
          description: Trip created successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Trip"
        "422":
          description: Validation error — missing required field or invalid date range.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      operationId: ListTrips
      summary: List all trips
      tags:
        - trips
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed).
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page (max 100).
      responses:
        "200":
          description: A paginated list of trips ordered by start_date descending.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripList"

  /trips/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: GetTrip
      summary: Get a trip by ID
      tags:
        - trips
      responses:
        "200":
          description: The requested trip.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Trip"
        "404":
          description: Trip not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      operationId: UpdateTrip
      summary: Update a trip
      tags:
        - trips
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTripRequest"
      responses:
        "200":
          description: The updated trip.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Trip"
        "404":
          description: Trip not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      operationId: DeleteTrip
      summary: Delete a trip
      tags:
        - trips
      responses:
        "204":
          description: Trip deleted successfully. No response body.
        "404":
          description: Trip not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /trips/{tripId}/stops:
    parameters:
      - name: tripId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      operationId: CreateStop
      summary: Create a stop on a trip
      tags:
        - stops
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateStopRequest"
      responses:
        "201":
          description: Stop created successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Stop"
        "404":
          description: Trip not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      operationId: ListStops
      summary: List all stops for a trip
      tags:
        - stops
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed).
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page (max 100).
      responses:
        "200":
          description: A paginated list of stops ordered by arrived_at ascending.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StopList"
        "404":
          description: Trip not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /trips/{tripId}/stops/{stopId}:
    parameters:
      - name: tripId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: stopId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: GetStop
      summary: Get a stop by ID
      tags:
        - stops
      responses:
        "200":
          description: The requested stop.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Stop"
        "404":
          description: Stop not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      operationId: UpdateStop
      summary: Update a stop
      tags:
        - stops
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateStopRequest"
      responses:
        "200":
          description: The updated stop.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Stop"
        "404":
          description: Stop not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      operationId: DeleteStop
      summary: Delete a stop
      tags:
        - stops
      responses:
        "204":
          description: Stop deleted successfully. No response body.
        "404":
          description: Stop not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /trips/{tripId}/stops/{stopId}/tags:
    parameters:
      - name: tripId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: stopId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      operationId: ListTagsByStop
      summary: List tags on a stop
      tags:
        - tags
      responses:
        "200":
          description: Tags linked to the stop, ordered by slug.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Tag"
        "404":
          description: Stop not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      operationId: AddTagToStop
      summary: Add a tag to a stop
      tags:
        - tags
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddTagRequest"
      responses:
        "201":
          description: Tag linked to the stop. Returns the tag.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "404":
          description: Stop not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error — tag name is required or contains no usable characters.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /trips/{tripId}/stops/{stopId}/tags/{slug}:
    parameters:
      - name: tripId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: stopId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: slug
        in: path
        required: true
        schema:
          type: string

    delete:
      operationId: RemoveTagFromStop
      summary: Remove a tag from a stop
      tags:
        - tags
      responses:
        "204":
          description: Tag removed from stop. No response body.
        "404":
          description: Tag not linked to stop.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          example: ok

    CreateTripRequest:
      type: object
      required:
        - name
        - start_date
      properties:
        name:
          type: string
          example: "Summer Tour 2025"
        start_date:
          type: string
          format: date
          example: "2025-06-01"
        end_date:
          type: string
          format: date
          example: "2025-06-15"
          nullable: true
        notes:
          type: string
          example: "Pacific coast route"

    Trip:
      type: object
      required:
        - id
        - name
        - start_date
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        name:
          type: string
          example: "Summer Tour 2025"
        start_date:
          type: string
          format: date
          example: "2025-06-01"
        end_date:
          type: string
          format: date
          example: "2025-06-15"
          nullable: true
        notes:
          type: string
          example: "Pacific coast route"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ErrorDetail:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code for client branching.
          example: "not_found"
        message:
          type: string
          description: Human-readable description of the error.
          example: "trip not found"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: "#/components/schemas/ErrorDetail"

    CreateStopRequest:
      type: object
      required:
        - name
        - arrived_at
      properties:
        name:
          type: string
          example: "Yellowstone Camp"
        location:
          type: string
          example: "Yellowstone, WY"
          nullable: true
        arrived_at:
          type: string
          format: date-time
          example: "2025-06-02T10:00:00Z"
        departed_at:
          type: string
          format: date-time
          example: "2025-06-04T09:00:00Z"
          nullable: true
        notes:
          type: string
          example: "Great views"
          nullable: true

    UpdateStopRequest:
      type: object
      required:
        - name
        - arrived_at
      properties:
        name:
          type: string
          example: "Yellowstone Camp"
        location:
          type: string
          example: "Yellowstone, WY"
          nullable: true
        arrived_at:
          type: string
          format: date-time
          example: "2025-06-02T10:00:00Z"
        departed_at:
          type: string
          format: date-time
          example: "2025-06-04T09:00:00Z"
          nullable: true
        notes:
          type: string
          example: "Great views"
          nullable: true

    Stop:
      type: object
      required:
        - id
        - trip_id
        - name
        - arrived_at
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        trip_id:
          type: string
          format: uuid
        name:
          type: string
          example: "Yellowstone Camp"
        location:
          type: string
          example: "Yellowstone, WY"
          nullable: true
        arrived_at:
          type: string
          format: date-time
          example: "2025-06-02T10:00:00Z"
        departed_at:
          type: string
          format: date-time
          example: "2025-06-04T09:00:00Z"
          nullable: true
        notes:
          type: string
          example: "Great views"
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UpdateTripRequest:
      type: object
      required:
        - name
        - start_date
      properties:
        name:
          type: string
          example: "Summer Tour 2025"
        start_date:
          type: string
          format: date
          example: "2025-06-01"
        end_date:
          type: string
          format: date
          example: "2025-06-15"
          nullable: true
        notes:
          type: string
          example: "Pacific coast route"

    Tag:
      type: object
      required:
        - id
        - name
        - slug
        - created_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "National Park"
        slug:
          type: string
          example: "national-park"
        created_at:
          type: string
          format: date-time

    AddTagRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: "National Park"

    ExportRow:
      type: object
      required:
        - trip_id
        - trip_name
        - trip_start_date
        - tags
      properties:
        trip_id:
          type: string
          format: uuid
        trip_name:
          type: string
          example: "Summer Tour 2025"
        trip_start_date:
          type: string
          format: date
          example: "2025-06-01"
        trip_end_date:
          type: string
          format: date
          example: "2025-06-15"
          nullable: true
        stop_name:
          type: string
          example: "Yellowstone Camp"
        stop_location:
          type: string
          example: "Yellowstone, WY"
          nullable: true
        arrived_at:
          type: string
          format: date-time
          nullable: true
        departed_at:
          type: string
          format: date-time
          nullable: true
        stop_notes:
          type: string
          nullable: true
        tags:
          type: array
          items:
            type: string
          example: ["camping", "national-park"]

    Pagination:
      type: object
      description: Pagination metadata returned with every list response.
      required:
        - page
        - limit
        - total
      properties:
        page:
          type: integer
          minimum: 1
          example: 1
        limit:
          type: integer
          minimum: 1
          example: 20
        total:
          type: integer
          minimum: 0
          description: Total number of items matching the query (across all pages).
          example: 45

    TripList:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Trip"
        pagination:
          $ref: "#/components/schemas/Pagination"

    StopList:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Stop"
        pagination:
          $ref: "#/components/schemas/Pagination"

    TagList:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Tag"
        pagination:
          $ref: "#/components/schemas/Pagination"
