# Migrations

All database migrations are managed with [goose](https://github.com/pressly/goose).
Migration files are plain SQL with `-- +goose Up` / `-- +goose Down` annotations.

## Running migrations

```bash
# Apply all pending migrations (dev DB)
make db/migrate

# Roll back the most recent migration
make db/rollback

# Wipe and re-apply from scratch (dev only)
make db/reset
```

The `DATABASE_URL` environment variable controls the target database.
Set it in your `.env` file (see `.env.example`).

## Migration files

| File | Description |
|------|-------------|
| `001_create_trips.sql`     | Core trips table |
| `002_create_stops.sql`     | Stops table; FK → trips |
| `003_create_tags.sql`      | Tags lookup table |
| `004_create_stop_tags.sql` | Stop↔Tag join table |

## Schema ERD

```
trips
├── id           UUID PK
├── name         TEXT NOT NULL
├── start_date   DATE NOT NULL
├── end_date     DATE
├── notes        TEXT
├── created_at   TIMESTAMPTZ NOT NULL
└── updated_at   TIMESTAMPTZ NOT NULL
       │
       │ 1
       │ ┆
       │ N
stops  │
├── id           UUID PK
├── trip_id      UUID FK → trips.id (CASCADE DELETE)
├── name         TEXT NOT NULL
├── location     TEXT
├── arrived_at   TIMESTAMPTZ NOT NULL
├── departed_at  TIMESTAMPTZ
├── notes        TEXT
├── created_at   TIMESTAMPTZ NOT NULL
└── updated_at   TIMESTAMPTZ NOT NULL
       │
       │ M
       │ ┆
       │ N
       │
stop_tags (join table)
├── stop_id      UUID FK → stops.id (CASCADE DELETE)
└── tag_id       UUID FK → tags.id  (CASCADE DELETE)
       │
       │ N
       │ ┆
       │ 1
tags
├── id           UUID PK
├── name         TEXT NOT NULL UNIQUE
└── created_at   TIMESTAMPTZ NOT NULL
```

## Notes

- All primary keys are UUIDs generated by `gen_random_uuid()` (Postgres 13+, no extension required).
- Timestamps are `TIMESTAMPTZ` (stored as UTC, displayed in session timezone). Never use `TIMESTAMP WITHOUT TIME ZONE`.
- `trips.end_date` is nullable — a trip in progress has no end date yet.
- `stops.departed_at` is nullable — a current stop has no departure time yet.
- Deleting a trip cascades to its stops, and deleting a stop cascades to its `stop_tags` rows.
  Tags themselves are independent and are not deleted when a stop is deleted.
